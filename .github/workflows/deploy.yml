name: Deploy to Server

on:
  push:
    branches:
      - main        # Production
      - develop     # Staging

jobs:
  deploy:
    runs-on: self-hosted  # Use your self-hosted runner
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # Updated to Node 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for Staging
        if: github.ref == 'refs/heads/develop'
        run: npm run build
        env:
          NODE_ENV: staging
          VITE_API_URL: https://staging-api.yourdomain.com

      - name: Build for Production
        if: github.ref == 'refs/heads/main'
        run: npm run build
        env:
          NODE_ENV: production
          VITE_BASE_API: /tms-api
          VITE_SECRET_KEY: 3ad78f77d8587bd7db20d1a59810281575f7c5962bee331f1e823c3653c6869a
          VITE_TARGET_PATH: /var/www/html/app
          VITE_BASE_PATH: /app/


      - name: Verify build output
        run: |
          echo "Checking if dist folder exists..."
          ls -la
          if [ -d "dist" ]; then
            echo "dist folder found:"
            ls -la dist/
          else
            echo "Error: dist folder not found!"
            exit 1
          fi

      - name: Set deployment path
        id: set-path
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "DEPLOY_PATH=${{ secrets.PRODUCTION_PATH }}" >> $GITHUB_OUTPUT
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
          else
            echo "DEPLOY_PATH=${{ secrets.STAGING_PATH }}" >> $GITHUB_OUTPUT
            echo "ENVIRONMENT=staging" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Server
        run: |
          # Deploy files with rsync (preserves permissions)
          rsync -avz --delete --chmod=D755,F644 dist/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ steps.set-path.outputs.DEPLOY_PATH }}/

      - name: Deployment notification
        run: |
          echo "âœ… Deployed to ${{ steps.set-path.outputs.ENVIRONMENT }} successfully!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"